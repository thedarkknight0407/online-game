<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>P2P Game Room with Gun.js</title>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  </head>
  <body>
    <h1>P2P Room Demo</h1>

    <div>
      <button id="createRoom">Create Room</button>
      <input type="text" id="joinRoomID" placeholder="Room ID" />
      <button id="joinRoom">Join Room</button>
    </div>

    <h3>Room ID: <span id="roomIDDisplay">None</span></h3>

    <input type="text" id="messageInput" placeholder="Type a message" />
    <button id="sendMessage">Send</button>

    <ul id="chat"></ul>

    <script>
      // Initialize Gun (P2P)
      const gun = Gun(); // Works fully P2P

      let roomID = null;
      let room = null;

      // Utilities
      function generateRoomID(length = 6) {
        const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
        let id = "";
        for (let i = 0; i < length; i++) {
          id += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return id;
      }

      // DOM Elements
      const roomDisplay = document.getElementById("roomIDDisplay");
      const chatList = document.getElementById("chat");
      const messageInput = document.getElementById("messageInput");

      // Create Room
      document.getElementById("createRoom").addEventListener("click", () => {
        roomID = generateRoomID();
        roomDisplay.textContent = roomID;
        room = gun.get(roomID);
        console.log("Room created:", roomID);

        // Listen to messages
        room
          .get("messages")
          .map()
          .on((msg) => {
            if (msg) addMessage(msg);
          });
      });

      // Join Room
      document.getElementById("joinRoom").addEventListener("click", () => {
        const inputID = document
          .getElementById("joinRoomID")
          .value.trim()
          .toUpperCase();
        if (!inputID) return alert("Enter Room ID");

        roomID = inputID;
        roomDisplay.textContent = roomID;
        room = gun.get(roomID);

        // Listen to messages
        room
          .get("messages")
          .map()
          .on((msg) => {
            if (msg) addMessage(msg);
          });

        console.log("Joined room:", roomID);
      });

      // Send Message
      document.getElementById("sendMessage").addEventListener("click", () => {
        const text = messageInput.value.trim();
        if (!text || !room) return;

        // Save message to Gun
        room.get("messages").set(text);
        messageInput.value = "";
      });

      // Display message in chat
      function addMessage(msg) {
        const li = document.createElement("li");
        li.textContent = msg;
        chatList.appendChild(li);
      }
    </script>
  </body>
</html>
