<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Co-op Game with Roles</title>
    <style>
      body {
        background: #111;
        color: white;
        text-align: center;
        font-family: sans-serif;
      }
      canvas {
        background: #222;
        display: block;
        margin: 10px auto;
      }
      input,
      button {
        font-size: 16px;
        margin: 5px;
      }
    </style>
  </head>
  <body>
    <h2>Co-op Game</h2>

    <div id="menu">
      <input id="room" placeholder="Room code" /><br />
      <input id="password" type="password" placeholder="Password" /><br />
      <button onclick="host()">Host</button>
      <button onclick="join()">Join</button>
    </div>

    <canvas id="c" width="400" height="400" style="display: none"></canvas>

    <script>
      const c = document.getElementById("c");
      const ctx = c.getContext("2d");
      const info = document.getElementById("info");

      let ws;
      let players = {};
      let myId = null;
      let board = [];
      let currentTurn = null;
      let winner = null;
      let winningLine = null;
      let flash = 0;
      let scores = {};

      // Helper to get server URL from query
      function getServerURL() {
        const url = new URLSearchParams(location.search).get("server");
        if (!url) {
          alert("Open like: index.html?server=wss://YOUR_NGROK_URL");
          throw "";
        }
        return url;
      }

      function randomRoom() {
        return Math.random().toString(36).slice(2, 6).toUpperCase();
      }

      function host() {
        const password = getPassword();
        const roomId = randomRoom();

        document.getElementById("room").value = roomId;
        alert("Room code: " + roomId + "\nShare this with your friend");

        ws = new WebSocket(getServerURL());
        ws.onopen = () => {
          ws.send(JSON.stringify({ type: "host", roomId, password }));
        };
        ws.onmessage = onMessage;
      }

      function join() {
        const roomId = document.getElementById("room").value.trim();
        const password = getPassword();

        ws = new WebSocket(getServerURL());
        ws.onopen = () => {
          ws.send(JSON.stringify({ type: "join", roomId, password }));
        };
        ws.onmessage = onMessage;
      }

      function getPassword() {
        const p = document.getElementById("password").value.trim();
        if (!p) {
          alert("Password required");
          throw "";
        }
        return p;
      }

      // Handle incoming messages
      function onMessage(e) {
        const data = JSON.parse(e.data);

        if (data.type === "hosted") myId = data.id;
        if (data.type === "joined") myId = data.id;

        if (data.type === "gameState") {
          board = data.board;
          currentTurn = data.currentTurn;
          winner = data.winner;
          players = data.players;
          scores = data.scores || scores;

          winningLine = data.winningLine;

          if (c.style.display === "none") {
            startGame();
          }
        }

        if (data.type === "error") alert(data.msg);
      }

      function startGame() {
        document.getElementById("menu").style.display = "none";
        c.style.display = "block";
        loop();
      }

      // Keyboard input
      const keys = { w: 0, a: 0, s: 0, d: 0, sp: 0 };

      document.addEventListener("keydown", (e) => {
        if (!ws || ws.readyState !== 1) return;
        const k = e.key.toLowerCase();
        if (k == " " && keys["sp"] === 0) {
          keys["sp"] = 1;
          sendKeys();
        } else if (keys.hasOwnProperty(k) && keys[k] === 0) {
          keys[k] = 1;
          //   ws.send(JSON.stringify({ type: "input", keys }));
          sendKeys();
        }
      });

      document.addEventListener("keyup", (e) => {
        if (!ws || ws.readyState !== 1) return;
        const k = e.key.toLowerCase();
        if (k == " " && keys["sp"] === 1) {
          keys["sp"] = 0;
          sendKeys();
        } else if (keys.hasOwnProperty(k) && keys[k] === 1) {
          keys[k] = 0;
          //   ws.send(JSON.stringify({ type: "input", keys }));
          sendKeys();
        }
      });

      function sendKeys() {
        if (!ws || ws.readyState !== 1) return;
        ws.send(JSON.stringify({ type: "input", keys }));
      }

      function getMousePosition(canvas, event) {
        const rect = canvas.getBoundingClientRect(); // Get canvas position and size
        return {
          x: event.clientX - rect.left, // Adjust event.clientX for canvas's left offset
          y: event.clientY - rect.top, // Adjust event.clientY for canvas's top offset
        };
      }

      // Render loop
      c.addEventListener("click", function (event) {
        if (!ws || ws.readyState !== 1) return;
        if (winner) return;

        const mousePos = getMousePosition(c, event);
        const row = Math.floor(mousePos.y / (400 / 3));
        const col = Math.floor(mousePos.x / (400 / 3));

        ws.send(
          JSON.stringify({
            type: "move",
            row,
            col,
          }),
        );
      });

      function loop() {
        ctx.clearRect(0, 0, c.width, c.height);
        flash += 0.1;

        if (!board || board.length !== 3) {
          requestAnimationFrame(loop);
          return;
        }

        ctx.fillStyle = "white";
        for (let i = 1; i < 3; i++) {
          ctx.fillRect((i * 400) / 3, 0, 10, 400);
          ctx.fillRect(0, (i * 400) / 3, 400, 10);
        }

        ctx.fillStyle = "white";
        for (let r = 0; r < 3; r++) {
          for (let c2 = 0; c2 < 3; c2++) {
            const cell = board[r][c2];

            if (cell !== null) {
              if (cell === "UNDO") {
                ctx.fillStyle = `rgba(255,255,255,${Math.abs(Math.sin(flash * 5))})`;
                ctx.fillRect(c2 * (400 / 3), r * (400 / 3), 400 / 3, 400 / 3);
              } else {
                const symbol = players[cell]?.symbol;

                ctx.fillStyle = symbol === "X" ? "#ff4c4c" : "#4ccfff";
                ctx.font = "bold 100px Arial";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";

                ctx.fillText(
                  symbol,
                  c2 * (400 / 3) + 400 / 6,
                  r * (400 / 3) + 400 / 6,
                );
              }
            }
          }
        }
        ctx.fillStyle = "white";
        ctx.font = "20px Arial";
        ctx.fillText(
          currentTurn === myId ? "Your Turn" : "Opponent's Turn",
          200,
          380,
        );

        ctx.fillStyle = "white";
        ctx.font = "20px Arial";
        ctx.textAlign = "left";

        if (players[myId]) {
          const opponentId = Object.keys(players).find((id) => id !== myId);

          const mySymbol = players[myId]?.symbol;
          const oppSymbol = players[opponentId]?.symbol;

          ctx.fillText(`${mySymbol}: ${scores[myId] || 0}`, 10, 20);

          ctx.fillText(`${oppSymbol}: ${scores[opponentId] || 0}`, 10, 45);
        }

        if (winningLine) {
          ctx.strokeStyle = `rgba(255,255,0,${Math.abs(Math.sin(flash))})`;
          ctx.lineWidth = 15;
          ctx.lineCap = "round";

          const [start, , end] = winningLine;

          const cellSize = 400 / 3;

          ctx.beginPath();
          ctx.moveTo(
            start[1] * cellSize + cellSize / 2,
            start[0] * cellSize + cellSize / 2,
          );
          ctx.lineTo(
            end[1] * cellSize + cellSize / 2,
            end[0] * cellSize + cellSize / 2,
          );
          ctx.stroke();
        }

        requestAnimationFrame(loop);
      }
    </script>
  </body>
</html>
