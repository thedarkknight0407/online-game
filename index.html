<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>1v1 Co-Op</title>
    <style>
      body {
        background: #111;
        color: white;
        font-family: sans-serif;
        text-align: center;
      }
      canvas {
        background: #222;
        display: block;
        margin: 10px auto;
      }
      input,
      button {
        font-size: 16px;
        margin: 5px;
      }
    </style>
  </head>
  <body>
    <h2>1v1 Co-Op Game</h2>

    <div id="menu">
      <input
        id="room"
        placeholder="Room code (host generates if empty)"
      /><br />
      <input id="password" type="password" placeholder="Password" /><br />
      <button onclick="host()">Host</button>
      <button onclick="join()">Join</button>
      <p id="info"></p>
    </div>

    <canvas id="c" width="600" height="400" style="display: none"></canvas>

    <script>
      const c = document.getElementById("c");
      const ctx = c.getContext("2d");
      const info = document.getElementById("info");

      let ws;
      let me = { x: 200, y: 200 };
      let other = { x: 350, y: 200 };

      function randomId(len = 4) {
        const chars = "ABCDEFGHJKMNPQRSTUVWXYZ123456789";
        let result = "";
        for (let i = 0; i < len; i++)
          result += chars.charAt(Math.floor(Math.random() * chars.length));
        return result;
      }

      function connect() {
        ws = new WebSocket("wss://abcd-1234-5678.ngrok.io");

        // ws = new WebSocket("wss://YOUR_SERVER_ADDRESS:8080"); // replace with your WS server
        ws.onmessage = (msg) => {
          let data;
          try {
            data = JSON.parse(msg.data);
          } catch {
            return;
          }

          if (data.type === "error") info.textContent = data.msg;
          if (data.type === "hosted") {
            info.textContent = `Room code: ${data.roomId}`;
          }
          if (data.type === "joined") {
            info.textContent = "Connected!";
            startGame();
          }
          if (data.type === "new-player") {
            console.log("Other player joined");
          }
          if (data.type === "position") {
            other = data.pos;
          }
        };
      }

      function host() {
        const password = document.getElementById("password").value.trim();
        if (!password) {
          info.textContent = "Password required";
          return;
        }
        const roomId = randomId();
        connect();
        ws.onopen = () =>
          ws.send(JSON.stringify({ type: "host", roomId, password }));
        document.getElementById("room").value = roomId;
      }

      function join() {
        const roomId = document.getElementById("room").value.trim();
        const password = document.getElementById("password").value.trim();
        if (!roomId || !password) {
          info.textContent = "Password required";
          return;
        }
        connect();
        ws.onopen = () =>
          ws.send(JSON.stringify({ type: "join", roomId, password }));
      }

      function startGame() {
        document.getElementById("menu").style.display = "none";
        c.style.display = "block";
        document.onkeydown = (e) => {
          if (!ws || ws.readyState !== 1) return;
          if (["w", "a", "s", "d"].includes(e.key.toLowerCase())) {
            if (e.key.toLowerCase() === "w") me.y -= 5;
            if (e.key.toLowerCase() === "s") me.y += 5;
            if (e.key.toLowerCase() === "a") me.x -= 5;
            if (e.key.toLowerCase() === "d") me.x += 5;
            me.x = Math.max(0, Math.min(me.x, c.width - 20));
            me.y = Math.max(0, Math.min(me.y, c.height - 20));
            ws.send(JSON.stringify({ type: "position", pos: me }));
          }
        };
        loop();
      }

      function loop() {
        ctx.clearRect(0, 0, c.width, c.height);
        ctx.fillStyle = "hotpink";
        ctx.fillRect(me.x, me.y, 20, 20);
        ctx.fillStyle = "cyan";
        ctx.fillRect(other.x, other.y, 20, 20);
        requestAnimationFrame(loop);
      }
    </script>
  </body>
</html>
