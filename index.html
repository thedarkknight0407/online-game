<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Co-op Game with Roles</title>
    <style>
      body {
        background: #111;
        color: white;
        text-align: center;
        font-family: sans-serif;
      }
      canvas {
        background: #222;
        display: block;
        margin: 10px auto;
      }
      input,
      button {
        font-size: 16px;
        margin: 5px;
      }
    </style>
  </head>
  <body>
    <h2>Co-op Game</h2>

    <div id="menu">
      <input id="room" placeholder="Room code" /><br />
      <input id="password" type="password" placeholder="Password" /><br />
      <button onclick="host()">Host</button>
      <button onclick="join()">Join</button>
    </div>

    <canvas id="c" width="600" height="400" style="display: none"></canvas>

    <script>
      const c = document.getElementById("c");
      const ctx = c.getContext("2d");

      let ws;
      let players = {};
      let myId = null;

      // Helper to get server URL from query
      function getServerURL() {
        const url = new URLSearchParams(location.search).get("server");
        if (!url) {
          alert("Open like: index.html?server=wss://YOUR_NGROK_URL");
          throw "";
        }
        return url;
      }

      function randomRoom() {
        return Math.random().toString(36).slice(2, 6).toUpperCase();
      }

      function host() {
        const password = getPassword();
        const roomId = randomRoom();
        document.getElementById("room").value = roomId;
        alert("Room code: " + roomId + "\nShare this with your friend");

        ws = new WebSocket(getServerURL());
        ws.onopen = () => {
          ws.send(JSON.stringify({ type: "host", roomId, password }));
        };
        ws.onmessage = onMessage;
      }

      function join() {
        const roomId = document.getElementById("room").value.trim();
        const password = getPassword();

        ws = new WebSocket(getServerURL());
        ws.onopen = () => {
          ws.send(JSON.stringify({ type: "join", roomId, password }));
        };
        ws.onmessage = onMessage;
      }

      function getPassword() {
        const p = document.getElementById("password").value.trim();
        if (!p) {
          alert("Password required");
          throw "hi";
        }
        return p;
      }

      // Handle incoming messages
      function onMessage(e) {
        const data = JSON.parse(e.data);

        if (data.type === "hosted") myId = data.id;
        if (data.type === "joined") myId = data.id;

        if (data.type === "state") {
          players = data.players;
          if (c.style.display === "none") startGame(); // auto-start when state received
        }

        if (data.type === "error") alert(data.msg);
      }

      function startGame() {
        document.getElementById("menu").style.display = "none";
        c.style.display = "block";
        loop();
      }

      // Keyboard input
      const keys = { w: 0, a: 0, s: 0, d: 0 };

      document.addEventListener("keydown", (e) => {
        if (!ws || ws.readyState !== 1) return;
        const k = e.key.toLowerCase();
        if (keys.hasOwnProperty(k) && keys[k] === 0) {
          keys[k] = 1;
          ws.send(JSON.stringify({ type: "input", keys }));
        }
      });

      document.addEventListener("keyup", (e) => {
        if (!ws || ws.readyState !== 1) return;
        const k = e.key.toLowerCase();
        if (keys.hasOwnProperty(k) && keys[k] === 1) {
          keys[k] = 0;
          ws.send(JSON.stringify({ type: "input", keys }));
        }
      });

      // Render loop
      function loop() {
        ctx.clearRect(0, 0, c.width, c.height);
        for (const id in players) {
          const p = players[id];
          if (!p.displayX) p.displayX = p.x;
          if (!p.displayY) p.displayY = p.y;

          const lerp = 0.2; // 0 = no movement, 1 = instant snap
          p.displayX += (p.x - p.displayX) * lerp;
          p.displayY += (p.y - p.displayY) * lerp;

          ctx.fillStyle = id === myId ? "hotpink" : p.color;
          ctx.fillRect(p.displayX, p.displayY, 20, 20);
        }
        requestAnimationFrame(loop);
      }
    </script>
  </body>
</html>
