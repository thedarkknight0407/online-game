<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Co-op Test</title>
    <style>
      body {
        background: #111;
        color: white;
        text-align: center;
        font-family: sans-serif;
      }
      canvas {
        background: #222;
        display: block;
        margin: 10px auto;
      }
      input,
      button {
        font-size: 16px;
        margin: 5px;
      }
    </style>
  </head>
  <body>
    <h2>Co-op Test</h2>

    <div id="menu">
      <input id="room" placeholder="Room code" /><br />
      <input id="password" type="password" placeholder="Password" /><br />
      <button onclick="host()">Host</button>
      <button onclick="join()">Join</button>
    </div>

    <canvas id="c" width="600" height="400" style="display: none"></canvas>

    <script>
      const c = document.getElementById("c");
      const ctx = c.getContext("2d");

      let ws;
      let players = {};
      let myId = null;

      function getServerURL() {
        const p = new URLSearchParams(location.search);
        const url = p.get("server");
        if (!url) {
          alert("Open like: github.io/.../?server=wss://YOUR_NGROK_URL");
          throw new Error("No server url");
        }
        return url;
      }

      function randomRoom() {
        return Math.random().toString(36).slice(2, 6).toUpperCase();
      }

      function host() {
        const password = passwordInput();
        const roomId = randomRoom();
        document.getElementById("room").value = roomId;

        ws = new WebSocket(getServerURL());
        ws.onopen = () => {
          ws.send(
            JSON.stringify({
              type: "host",
              roomId,
              password,
            }),
          );
        };
        ws.onmessage = onMessage;
      }

      function join() {
        const roomId = document.getElementById("room").value.trim();
        const password = passwordInput();

        ws = new WebSocket(getServerURL());
        ws.onopen = () => {
          ws.send(
            JSON.stringify({
              type: "join",
              roomId,
              password,
            }),
          );
        };
        ws.onmessage = onMessage;
      }

      function passwordInput() {
        const p = document.getElementById("password").value.trim();
        if (!p) {
          alert("Password required");
          throw "";
        }
        return p;
      }

      function onMessage(e) {
        const data = JSON.parse(e.data);

        if (data.type === "hosted") {
          myId = data.id;
          // stay in menu, just wait
        }

        if (data.type === "joined") {
          myId = data.id;
          startGame();
        }

        if (data.type === "state") {
          players = data.players;
        }

        if (data.type === "error") {
          alert(data.msg);
        }
      }

      document.addEventListener("keydown", (e) => {
        if (!ws || ws.readyState !== 1) return;
        if ("wasd".includes(e.key)) {
          ws.send(
            JSON.stringify({
              type: "input",
              dir: e.key,
            }),
          );
        }
      });

      function startGame() {
        document.getElementById("menu").style.display = "none";
        c.style.display = "block";
        loop();
      }

      function loop() {
        ctx.clearRect(0, 0, c.width, c.height);
        for (const id in players) {
          const p = players[id];
          ctx.fillStyle = id === myId ? "hotpink" : "cyan";
          ctx.fillRect(p.x, p.y, 20, 20);
        }
        requestAnimationFrame(loop);
      }
    </script>
  </body>
</html>
