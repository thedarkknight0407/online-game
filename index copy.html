<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>2-Player Co-Op</title>
    <style>
      body {
        background: #111;
        color: white;
        text-align: center;
        font-family: sans-serif;
      }
      canvas {
        background: #222;
        display: block;
        margin: 10px auto;
      }
      input,
      button {
        font-size: 16px;
        margin: 5px;
      }
    </style>
  </head>
  <body>
    <h2>Co-Op Game ❤️</h2>

    <div id="menu">
      <input id="room" placeholder="Room code (host auto generates)" /><br />
      <input id="password" type="password" placeholder="Password" /><br />
      <button onclick="host()">Host</button>
      <button onclick="join()">Join</button>
      <p
        id="info"
        style="
          background: rgba(255, 255, 255, 0.1);
          padding: 10px;
          border-radius: 8px;
          width: 320px;
          margin: 10px auto;
        "
      ></p>
    </div>

    <canvas id="c" width="600" height="400" style="display: none"></canvas>

    <script>
      const c = document.getElementById("c");
      const ctx = c.getContext("2d");
      const info = document.getElementById("info");

      let ws;
      let myId;
      let players = {};
      let displayPlayers = {}; // for interpolation

      // Helpers
      function randomRoom() {
        return Math.random().toString(36).substr(2, 4).toUpperCase();
      }

      // Host room
      function host() {
        const password = document.getElementById("password").value.trim();
        if (!password) {
          info.textContent = "Password required";
          return;
        }
        const roomId = randomRoom();
        ws = new WebSocket("ws://localhost:8080");
        ws.onopen = () => {
          ws.send(JSON.stringify({ type: "host", roomId, password }));
        };
        ws.onmessage = handleMessage;
      }

      // Join room
      function join() {
        const roomId = document
          .getElementById("room")
          .value.trim()
          .toUpperCase();
        const password = document.getElementById("password").value.trim();
        if (!roomId || !password) {
          info.textContent = "Room & password required";
          return;
        }
        ws = new WebSocket("ws://localhost:8080");
        ws.onopen = () => {
          ws.send(JSON.stringify({ type: "join", roomId, password }));
        };
        ws.onmessage = handleMessage;
      }

      // Handle server messages
      function handleMessage(evt) {
        let data = JSON.parse(evt.data);
        if (data.type === "error") info.textContent = data.msg;
        else if (data.type === "hostCreated") {
          info.textContent = `Room code: ${data.roomId} | Password: (hidden)`;
          myId = "host";
          start();
        } else if (data.type === "joined") {
          info.textContent = "Joined! Waiting for updates...";
          myId = Object.keys(data.players).find(
            (id) => data.players[id].role !== "host",
          ); // guest id
          players = data.players;
          start();
        } else if (data.type === "state") {
          players = data.players;
        }
      }

      // Start game
      function start() {
        document.getElementById("menu").style.display = "none";
        c.style.display = "block";
        requestAnimationFrame(loop);
      }

      // Keyboard input
      const keys = { w: 0, a: 0, s: 0, d: 0 };
      document.addEventListener("keydown", (e) => {
        const k = e.key.toLowerCase();
        if (keys.hasOwnProperty(k) && keys[k] === 0) {
          keys[k] = 1;
          sendKeys();
        }
      });
      document.addEventListener("keyup", (e) => {
        const k = e.key.toLowerCase();
        if (keys.hasOwnProperty(k) && keys[k] === 1) {
          keys[k] = 0;
          sendKeys();
        }
      });

      function sendKeys() {
        if (!ws || ws.readyState !== 1) return;
        ws.send(JSON.stringify({ type: "input", keys }));
      }

      // Interpolated drawing
      function loop() {
        ctx.clearRect(0, 0, c.width, c.height);
        for (const id in players) {
          const p = players[id];
          if (!displayPlayers[id]) displayPlayers[id] = { x: p.x, y: p.y };
          const dp = displayPlayers[id];

          const lerp = 0.2;
          dp.x += (p.x - dp.x) * lerp;
          dp.y += (p.y - dp.y) * lerp;

          ctx.fillStyle = id === myId ? "hotpink" : p.color;
          ctx.fillRect(dp.x, dp.y, 20, 20);
        }
        requestAnimationFrame(loop);
      }
    </script>
  </body>
</html>
